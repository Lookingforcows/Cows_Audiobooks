<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Matrix Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #login-container, #chat-container {
      margin-bottom: 20px;
    }
    #chat-container {
      display: none;
    }
    .message {
      padding: 5px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .sent {
      background-color: #e0f7fa;
    }
    .received {
      background-color: #f0f0f0;
    }
  </style>

  <!-- Load the Matrix SDK via CDN as a module -->
  <script type="module">
    import * as sdk from 'https://cdn.jsdelivr.net/npm/matrix-js-sdk@36.2.0/lib/index.js';

    window.addEventListener('DOMContentLoaded', () => {
      let client;
      const homeserverUrl = "https://secret.lookingforcows.com:8448";
      const domain = "secret.lookingforcows.com";
      const roomId = "!yourRoomId:secret.lookingforcows.com"; // Replace this with your room ID

      // Login button handler
      document.getElementById("loginButton").addEventListener("click", async function () {
        const usernameInput = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = "";

        if (!usernameInput || !password) {
          errorMessage.textContent = "Username and password are required.";
          return;
        }

        // Automatically format the username (e.g., "john" becomes "@john:secret.lookingforcows.com")
        const fullUsername = `@${usernameInput}:${domain}`;
        console.log("Attempting login as: " + fullUsername);

        try {
          // Create the Matrix client using the locally loaded SDK
          client = sdk.createClient({ baseUrl: homeserverUrl });
          const loginResponse = await client.loginWithPassword(fullUsername, password);
          console.log("Login successful:", loginResponse);

          // Hide the login form and show the chat interface
          document.getElementById("login-container").style.display = "none";
          document.getElementById("chat-container").style.display = "block";

          // Start syncing with the homeserver
          client.startClient();

          // Join the room
          await client.joinRoom(roomId);

          // Listen for new messages in the room
          client.on("Room.timeline", (event, room) => {
            if (event.getType() === "m.room.message" && event.getSender() !== client.getUserId()) {
              const messageDiv = document.createElement("div");
              messageDiv.classList.add("message", "received");
              messageDiv.textContent = event.getContent().body;
              document.getElementById("messages").appendChild(messageDiv);
            }
          });
        } catch (err) {
          console.error("Login failed:", err);
          errorMessage.textContent = "Login failed! Check your username and password.";
        }
      });

      // Handle sending messages
      document.getElementById("sendMessageButton").addEventListener("click", async function () {
        const messageText = document.getElementById("messageInput").value.trim();
        if (!messageText || !client) return;

        // Send the message to the room
        try {
          await client.sendTextMessage(roomId, messageText);
          // Show sent message in UI
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message", "sent");
          messageDiv.textContent = messageText;
          document.getElementById("messages").appendChild(messageDiv);
          document.getElementById("messageInput").value = ""; // Clear the input
        } catch (err) {
          console.error("Failed to send message:", err);
        }
      });
    });
  </script>
</head>
<body>
  <!-- Login Form -->
  <div id="login-container">
    <h2>Login to Matrix</h2>
    <input type="text" id="username" placeholder="Username" required /><br />
    <input type="password" id="password" placeholder="Password" required /><br />
    <button id="loginButton">Login</button>
    <p id="error-message" style="color: red;"></p>
  </div>

  <!-- Chat Container -->
  <div id="chat-container">
    <h2>Chat Room</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type your message" />
    <button id="sendMessageButton">Send</button>
  </div>
</body>
</html>
