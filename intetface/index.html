<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Matrix Chat</title>
  <!-- Load the Matrix JS SDK from unpkg. We use defer so it loads before our code runs. -->
  <script src="https://unpkg.com/matrix-js-sdk@latest" defer></script>
  <style>
    #login-container { padding: 20px; }
    #chat-container { display: none; padding: 20px; }
    .message { padding: 5px; margin: 5px; border: 1px solid #ccc; }
    .sent { background-color: #e0f7fa; }
    .received { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div id="login-container">
    <h2>Login to Matrix</h2>
    <input type="text" id="username" placeholder="Username" required><br>
    <input type="password" id="password" placeholder="Password" required><br>
    <button id="loginButton">Login</button>
    <p id="error-message" style="color: red;"></p>
  </div>

  <!-- Chat Container -->
  <div id="chat-container">
    <h2>Chat Room</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type your message" />
    <button id="sendMessageButton">Send</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Ensure the SDK is loaded
      if (typeof matrixcs === 'undefined') {
        console.error("Matrix SDK failed to load.");
        document.getElementById("error-message").textContent = "Matrix SDK failed to load.";
        return;
      }
      console.log("Matrix SDK loaded successfully.");

      let client;
      const homeserverUrl = "https://secret.lookingforcows.com:8448";
      const domain = "secret.lookingforcows.com";

      // Login button click handler
      document.getElementById("loginButton").addEventListener("click", async function () {
        const usernameInput = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = "";

        if (!usernameInput || !password) {
          errorMessage.textContent = "Username and password are required.";
          return;
        }

        // Automatically format the username for the user (e.g. "john" becomes "@john:secret.lookingforcows.com")
        const fullUsername = `@${usernameInput}:${domain}`;
        console.log("Attempting login as: " + fullUsername);

        try {
          // Create the Matrix client using the global matrixcs object
          client = matrixcs.createClient({ baseUrl: homeserverUrl });
          const loginResponse = await client.loginWithPassword(fullUsername, password);
          console.log("Login successful:", loginResponse);

          // Hide the login form and show the chat interface
          document.getElementById("login-container").style.display = "none";
          document.getElementById("chat-container").style.display = "block";

          // Start syncing with the homeserver
          client.startClient();
        } catch (err) {
          console.error("Login failed:", err);
          errorMessage.textContent = "Login failed! Check your username and password.";
        }
      });

      // (Optional) Send message button â€“ you'll need to implement room joining logic for a full chat experience.
      document.getElementById("sendMessageButton").addEventListener("click", async function () {
        const messageText = document.getElementById("messageInput").value.trim();
        if (!messageText || !client) return;
        // Send message logic goes here.
        // For example, if you have a currentRoomId defined:
        // await client.sendTextMessage(currentRoomId, messageText);
        console.log("Sending message:", messageText);
      });
    });
  </script>
</body>
</html>
